<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.2.1/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.2.1/styles/ag-theme-quartz.css"
    />
    <script src="https://unpkg.com/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.7"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/tippy.js@6.3.7/dist/tippy.css"
    />
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: 2rem;
        line-height: 1.6;
      }

      .nav-select {
        padding: 8px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f8f8;
        min-width: 200px;
        margin-bottom: 2rem;
      }

      #myGrid {
        height: 600px;
        width: 100%;
      }

      .explanation {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
        border-radius: 4px;
      }

      .explanation h2 {
        margin-top: 0;
        font-size: 1.2rem;
        color: #333;
      }

      .explanation p {
        margin: 0.5rem 0;
      }

      .explanation ul, .explanation ol {
        margin: 0.5rem 0;
        padding-left: 2rem;
      }

      .explanation code {
        background-color: #e9ecef;
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        font-family: monospace;
      }

      .explanation strong {
        font-weight: 600;
      }

      .error-message {
        padding: 10px;
        color: #721c24;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
      }

      .card-link {
        color: #58a6ff;
        text-decoration: none;
        cursor: pointer;
        font-weight: 500;
      }

      .card-link:hover {
        color: #79c0ff;
        text-decoration: underline;
      }

      .tippy-box {
        background-color: #333;
      }

      .tippy-box[data-theme~='card'] {
        background-color: transparent;
        padding: 0;
      }

      .tippy-box[data-theme~='card'] .tippy-content {
        padding: 0;
      }

      .card-tooltip-image {
        display: block;
        max-width: 488px;
        height: auto;
        border-radius: 13px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <main>
      <select class="nav-select" onchange="window.location.href=this.value">
        <option value="">Select a view...</option>
        {% for link in nav_links %}
        <option value="{{ link.url }}" {% if link.url == data_file %}selected{% endif %}>{{ link.display_name }}</option>
        {% endfor %}
      </select>
      
      <h1>{{ display_name }}</h1>

      {% if explanation %}
      <div class="explanation">
        {{ explanation | safe }}
      </div>
      {% endif %}

      <div id="myGrid" class="ag-theme-quartz-auto-dark"></div>
    </main>

    <script>
      // Card Link Cell Renderer
      class CardLinkRenderer {
        constructor() {
          this.tippyInstances = [];
        }

        init(params) {
          this.eGui = document.createElement('span');

          const cardData = params.data;
          const colDef = params.colDef;
          const value = params.value;

          if (!value) {
            this.eGui.textContent = '';
            return;
          }

          // Handle multiple cards (comma-separated)
          // Note: This assumes card names don't contain commas. Cards with commas
          // (e.g., "_____", Creature Collector" from Unfinity) are extremely rare
          // and typically filtered out by is_traditional_card().
          const cardNames = value.split(',').map(name => name.trim());

          cardNames.forEach((cardName, index) => {
            if (index > 0) {
              this.eGui.appendChild(document.createTextNode(', '));
            }

            const link = document.createElement('a');
            link.className = 'card-link';
            link.textContent = cardName;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';

            // Determine the card's Scryfall URI and image
            const cardInfo = this.getCardInfo(cardData, cardName, colDef);

            if (cardInfo.scryfallUri) {
              link.href = cardInfo.scryfallUri;
            } else {
              // Fallback: search by exact card name
              link.href = `https://scryfall.com/search?q=${encodeURIComponent(`!"${cardName}"`)}`;
            }

            // Add tooltip with card image if available
            if (cardInfo.imageUri) {
              // Create image element using DOM to prevent XSS
              const img = document.createElement('img');
              img.src = cardInfo.imageUri;
              img.alt = `Magic: The Gathering card - ${cardName}`;
              img.className = 'card-tooltip-image';
              img.onerror = function () {
                // Replace broken image with a text fallback in the tooltip
                try {
                  this.replaceWith(document.createTextNode('Card image unavailable'));
                } catch (e) {
                  this.style.display = 'none';
                }
              };

              const tippyInstance = tippy(link, {
                content: img,
                theme: 'card',
                placement: 'right',
                arrow: false,
                maxWidth: 'none',
                delay: [200, 0],
                trigger: 'mouseenter focus'
              });
              this.tippyInstances.push(tippyInstance);
            }

            this.eGui.appendChild(link);
          });
        }

        getCardInfo(cardData, cardName, colDef) {
          // If column has cardLinkData specified, use that field's data
          const linkDataField = colDef.cardLinkData;

          if (linkDataField && cardData[linkDataField]) {
            // Handle array of card objects (e.g., supercycle members)
            if (Array.isArray(cardData[linkDataField])) {
              const cardInfo = cardData[linkDataField].find(c => c.name === cardName);
              if (cardInfo) {
                return {
                  scryfallUri: cardInfo.scryfall_uri || null,
                  imageUri: cardInfo.image_uri || null
                };
              } else {
                // Log a warning when the expected card is not found in the array
                console.warn(
                  '[CardLinkRenderer] Expected card "%s" in array field "%s", but no matching entry was found. Falling back to row-level card data.',
                  cardName,
                  linkDataField
                );
              }
            } else {
              // Single card object
              const cardInfo = cardData[linkDataField];
              return {
                scryfallUri: cardInfo.scryfall_uri || null,
                imageUri: cardInfo.image_uri || null
              };
            }
          }

          // Fallback: look in row data itself
          return {
            scryfallUri: cardData.scryfall_uri || null,
            imageUri: cardData.image_uri || null
          };
        }

        getGui() {
          return this.eGui;
        }

        refresh(params) {
          return false;
        }

        destroy() {
          // Clean up Tippy instances to prevent memory leaks
          if (this.tippyInstances) {
            this.tippyInstances.forEach(instance => {
              if (instance && instance.destroy) {
                instance.destroy();
              }
            });
            this.tippyInstances = [];
          }
        }
      }

      // Initialize grid with loading state
      const columnDefs = {{ column_defs | tojson }};

      const gridOptions = {
        theme: "legacy",
        columnDefs: columnDefs,
        rowData: null,
        loading: true,
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true
        },
        components: {
          cardLinkRenderer: CardLinkRenderer
        },
        pagination: true,
        paginationPageSize: 100
      };

      const gridDiv = document.querySelector('#myGrid');
      const gridApi = agGrid.createGrid(gridDiv, gridOptions);

      // Fetch data and update grid
      fetch('{{ data_file }}')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          gridApi.setGridOption('rowData', data);
          gridApi.setGridOption('loading', false);
        })
        .catch(error => {
          console.error('Error loading data:', error);
          gridApi.setGridOption('loading', false);

          // Create error element using DOM API to prevent XSS
          const errorSpan = document.createElement('span');
          errorSpan.className = 'error-message';
          errorSpan.textContent = `Error loading data: ${error.message}`;

          gridApi.setGridOption('overlayNoRowsTemplate', errorSpan.outerHTML);
          gridApi.showNoRowsOverlay();
        });
    </script>
  </body>
</html>
